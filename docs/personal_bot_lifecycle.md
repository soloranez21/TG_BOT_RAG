# –ê–Ω–∞–ª–∏–∑ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ TG_BOT_RAG, –æ—Ç –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

### 1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞** (–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞)

#### –ú–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ `spawn_personal_bot()`:

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞** (`handlers.py:144`)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`
   - –í–≤–æ–¥–∏—Ç —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
   - –í–≤–æ–¥–∏—Ç OpenAI API –∫–ª—é—á
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `spawn_personal_bot()`

2. **–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞** (`handlers.py:211`)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/restart`
   - –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `spawn_personal_bot()`

3. **–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Master Bot** (`main.py:51`)
   - Master Bot –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
   - –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ –±–æ—Ç—ã –∏–∑ –ë–î
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `respawn_all_bots()` ‚Üí `spawn_personal_bot()`

---

### 2. **–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞** (`process_manager.py:spawn_personal_bot()`)

#### –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```
[SPAWN] Starting spawn process for user {telegram_user_id}
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞: –£–∂–µ –∑–∞–ø—É—â–µ–Ω?
    ‚îú‚îÄ –î–∞ ‚Üí [SPAWN] Bot is already running (PID: {pid})
    ‚îî‚îÄ –ù–µ—Ç ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        ‚Üì
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏: get_personal_bot_path()
    ‚Üí src/personal_bot/main.py
        ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞: –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
    ‚îú‚îÄ –ù–µ—Ç ‚Üí [SPAWN] Personal bot script not found
    ‚îî‚îÄ –î–∞ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        ‚Üì
–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:
    [sys.executable, main.py, --user-id, --bot-token, --openai-key, --collection, --qdrant-url]
        ‚Üì
subprocess.Popen()
    ‚îú‚îÄ stdout=PIPE
    ‚îú‚îÄ stderr=PIPE
    ‚îú‚îÄ text=True
    ‚îî‚îÄ bufsize=1
        ‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ running_bots[telegram_user_id]
        ‚Üì
[SPAWN] ‚úÖ Spawned personal bot (PID: {proc.pid})
        ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫: –ü—Ä–æ—Ü–µ—Å—Å –∂–∏–≤?
    ‚îú‚îÄ –ù–µ—Ç ‚Üí [SPAWN] ‚ùå Process died immediately!
    ‚îÇ         ‚îî‚îÄ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ STDOUT/STDERR
    ‚îî‚îÄ –î–∞ ‚Üí [SPAWN] Process is alive and running
```

---

### 3. **–ó–∞–ø—É—Å–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞** (`personal_bot/main.py`)

#### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

```python
if __name__ == "__main__":
    asyncio.run(main())
        ‚Üì
parse_args()  # –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    ‚Üì
logger.info(f"Starting Personal Bot for user {args.user_id}")
    ‚Üì
Bot(token=args.bot_token)  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞
    ‚Üì
Dispatcher(storage=MemoryStorage())
    ‚Üì
DocumentProcessor()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    ‚Üì
RAGChain(openai_key, qdrant_url, collection_name)  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG
    ‚Üì
dp.include_router(router)  # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    ‚Üì
logger.info(f"Personal Bot for user {args.user_id} is running...")
    ‚Üì
await dp.start_polling(bot)  # –ó–∞–ø—É—Å–∫ polling
```

---

### 4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞**

#### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:

1. **`is_bot_running(telegram_user_id)`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `proc.poll() is None`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤

2. **`get_bot_process_info(telegram_user_id)`**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
     - `status`: "running" | "terminated" | "not_found"
     - `pid`: ID –ø—Ä–æ—Ü–µ—Å—Å–∞
     - `exit_code`: –ö–æ–¥ –≤—ã—Ö–æ–¥–∞ (–µ—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω)
     - `stdout`: –í—ã–≤–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞
     - `stderr`: –û—à–∏–±–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞

3. **`get_running_bot_count()`**
   - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

---

### 5. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞** (`process_manager.py:stop_personal_bot()`)

#### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

```
–ü—Ä–æ–≤–µ—Ä–∫–∞: –ü—Ä–æ—Ü–µ—Å—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
    ‚îú‚îÄ –ù–µ—Ç ‚Üí return False
    ‚îî‚îÄ –î–∞ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        ‚Üì
proc.terminate()  # –ú—è–≥–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (SIGTERM)
        ‚Üì
proc.wait(timeout=5)  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è 5 —Å–µ–∫
        ‚Üì
–ó–∞–≤–µ—Ä—à–∏–ª—Å—è?
    ‚îú‚îÄ –ù–µ—Ç ‚Üí proc.kill()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (SIGKILL)
    ‚îÇ         ‚îî‚îÄ proc.wait()
    ‚îî‚îÄ –î–∞ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        ‚Üì
del running_bots[telegram_user_id]
        ‚Üì
logger.info(f"Stopped personal bot for user {telegram_user_id}")
```

---

## üêõ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

1. **`/status`** - –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
2. **`/debug`** - –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (NEW!)
3. **`/restart`** - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[SPAWN]`:

```
[SPAWN] Starting spawn process for user {id}
[SPAWN] Personal bot path: {path}
[SPAWN] Command: {cmd}
[SPAWN] Python executable: {python}
[SPAWN] ‚úÖ Spawned personal bot (PID: {pid})
[SPAWN] Process is alive and running
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Process died immediately**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ STDERR –≤ –ª–æ–≥–∞—Ö
   - –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
     - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
     - –ù–µ–≤–µ—Ä–Ω—ã–π OpenAI –∫–ª—é—á
     - Qdrant –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
     - –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π

2. **Bot not responding**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/debug` –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ PID –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ –∑–∞–¥–∞—á
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ master_bot

3. **Process not found**
   - –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω
   - –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/restart`

---

## üîç –¢–æ—á–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

### –í –∫–æ–¥–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. **process_manager.py**:
   - –ù–∞—á–∞–ª–æ spawn –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ü—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É
   - –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
   - PID –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
   - STDOUT/STDERR –ø—Ä–∏ –æ—à–∏–±–∫–µ

2. **personal_bot/main.py**:
   - –ù–∞—á–∞–ª–æ –∑–∞–ø—É—Å–∫–∞
   - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

3. **handlers.py**:
   - –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `/debug` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### `running_bots` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å)

```python
running_bots: dict[int, subprocess.Popen] = {
    telegram_user_id: Popen_object
}
```

### –ê—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞:

```bash
python src/personal_bot/main.py \
    --user-id 123456789 \
    --bot-token "123456:ABC..." \
    --openai-key "sk-..." \
    --collection "user_123456789" \
    --qdrant-url "http://localhost:6333"
```

---

## ‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ master bot
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/debug` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ master bot
5. –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É–º–∏—Ä–∞–µ—Ç —Å—Ä–∞–∑—É, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ STDERR –≤ –≤—ã–≤–æ–¥–µ `/debug`
